#include "GeneralStore.h"
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QGridLayout>
#include <QGroupBox>
#include <QDebug> // For simple console output

GeneralStore::GeneralStore(QWidget *parent) : QDialog(parent)
{
    setWindowTitle("General Store");
    setupUi();
    populateBuyItemsList();

    // Connect signals and slots
    connect(uncurseButton, &QPushButton::clicked, this, &GeneralStore::uncurseItem);
    connect(combineButton, &QPushButton::clicked, this, &GeneralStore::combineItems);
    connect(sellButton, &QPushButton::clicked, this, &GeneralStore::identifySellItem); // Using one slot for ID/Sell
    connect(idButton, &QPushButton::clicked, this, &GeneralStore::identifySellItem);
    connect(infoButton, &QPushButton::clicked, this, &GeneralStore::showItemInfo);
    connect(buyButton, &QPushButton::clicked, this, &GeneralStore::buyItem);
    connect(buyInfoButton, &QPushButton::clicked, this, &GeneralStore::showItemInfo);
    connect(searchItemsLineEdit, &QLineEdit::textChanged, this, &GeneralStore::searchItems);
    connect(exitButton, &QPushButton::clicked, this, &GeneralStore::exitStore);

    // Example: Update cost when item selected in buy list
    connect(buyItemsListWidget, &QListWidget::currentItemChanged, this, [this](QListWidgetItem *current, QListWidgetItem *previous) {
        if (current) {
            // In a real application, you'd fetch the actual cost from a data structure
            buyItemLineEdit->setText(current->text()); // Display selected item name
            buyItemCostLabel->setText("Cost: ???"); // Placeholder
        } else {
            buyItemLineEdit->clear();
            buyItemCostLabel->setText("Cost: ");
        }
    });
}

GeneralStore::~GeneralStore()
{
    // Destructor (Qt handles child widget destruction)
}

void GeneralStore::setupUi()
{
    // Main layout for the entire dialog
    QHBoxLayout *mainLayout = new QHBoxLayout(this);

    // --- Left Section Layout ---
    QVBoxLayout *leftLayout = new QVBoxLayout();
    leftLayout->setSpacing(10); // Spacing between groups

    // Group Box for "Uncurse Items"
    QGroupBox *uncurseGroupBox = new QGroupBox("Uncurse Items");
    QGridLayout *uncurseLayout = new QGridLayout(uncurseGroupBox);
    uncurseItemLineEdit = new QLineEdit();
    uncurseButton = new QPushButton("Uncurse");
    uncurseLayout->addWidget(new QLabel("Item"), 0, 0);
    uncurseLayout->addWidget(uncurseItemLineEdit, 0, 1);
    uncurseLayout->addWidget(new QLabel("Cost"), 1, 0); // Assuming a cost label
    uncurseLayout->addWidget(new QLabel(""), 1, 1); // Placeholder for cost value
    uncurseLayout->addWidget(uncurseButton, 0, 2, 2, 1); // Span 2 rows
    leftLayout->addWidget(uncurseGroupBox);

    // Group Box for "Combine Items"
    QGroupBox *combineGroupBox = new QGroupBox("Combine Items");
    QGridLayout *combineLayout = new QGridLayout(combineGroupBox);
    combineItemLineEdit = new QLineEdit();
    combineItemsLineEdit = new QLineEdit();
    combineButton = new QPushButton("Combine");
    combineLayout->addWidget(new QLabel("Item"), 0, 0);
    combineLayout->addWidget(combineItemLineEdit, 0, 1);
    combineLayout->addWidget(new QLabel("Items"), 1, 0);
    combineLayout->addWidget(combineItemsLineEdit, 1, 1);
    combineLayout->addWidget(combineButton, 0, 2, 2, 1);
    leftLayout->addWidget(combineGroupBox);

    // Group Box for "Identify, Realign & Sell Items"
    QGroupBox *identifySellGroupBox = new QGroupBox("Identify, Realign & Sell Items");
    QGridLayout *identifySellLayout = new QGridLayout(identifySellGroupBox);
    identifySellItemLineEdit = new QLineEdit();
    itemValueLabel = new QLabel("Value:"); // Will display actual value
    infoButton = new QPushButton("Info");
    sellButton = new QPushButton("Sell");
    idButton = new QPushButton("ID");
    idCostLabel = new QLabel("ID Cost:"); // Will display ID cost

    identifySellLayout->addWidget(new QLabel("Item"), 0, 0);
    identifySellLayout->addWidget(identifySellItemLineEdit, 0, 1, 1, 2); // Span 2 columns
    identifySellLayout->addWidget(itemValueLabel, 1, 0, 1, 3); // Span 3 columns
    identifySellLayout->addWidget(infoButton, 2, 0);
    identifySellLayout->addWidget(sellButton, 2, 1);
    identifySellLayout->addWidget(idButton, 2, 2);
    identifySellLayout->addWidget(idCostLabel, 3, 0, 1, 3); // Span 3 columns
    leftLayout->addWidget(identifySellGroupBox);

    // Add left section to main layout
    mainLayout->addLayout(leftLayout);

    // --- Right Section Layout ---
    QVBoxLayout *rightLayout = new QVBoxLayout();
    rightLayout->setSpacing(5);

    QLabel *buyItemsTitle = new QLabel("Buy Items");
    buyItemsTitle->setStyleSheet("font-weight: bold;"); // Make it stand out
    rightLayout->addWidget(buyItemsTitle);

    buyItemsListWidget = new QListWidget();
    rightLayout->addWidget(buyItemsListWidget);

    // Search input
    QHBoxLayout *searchLayout = new QHBoxLayout();
    searchItemsLineEdit = new QLineEdit();
    searchItemsLineEdit->setPlaceholderText("Search for What?");
    //searchLayout->addWidget(new QLabel("Search for What?")); // Label like in image
    searchLayout->addWidget(searchItemsLineEdit);
    rightLayout->addLayout(searchLayout);

    // Item details for buying
    QHBoxLayout *buyDetailsLayout = new QHBoxLayout();
    buyItemLineEdit = new QLineEdit(); // Display selected item name
    buyItemLineEdit->setReadOnly(true); // User shouldn't type here
    buyItemCostLabel = new QLabel("Cost:");
    buyDetailsLayout->addWidget(new QLabel("Item"));
    buyDetailsLayout->addWidget(buyItemLineEdit);
    buyDetailsLayout->addWidget(buyItemCostLabel); // Display the cost next to item
    rightLayout->addLayout(buyDetailsLayout);

    // Buy and Info buttons for selected item
    QHBoxLayout *buyButtonsLayout = new QHBoxLayout();
    buyButton = new QPushButton("BUY");
    buyInfoButton = new QPushButton("INFO");
    buyButtonsLayout->addStretch(); // Push buttons to the right
    buyButtonsLayout->addWidget(buyButton);
    buyButtonsLayout->addWidget(buyInfoButton);
    rightLayout->addLayout(buyButtonsLayout);

    // Exit button
    exitButton = new QPushButton("EXIT");
    rightLayout->addWidget(exitButton, 0, Qt::AlignRight); // Align to the right

    // Add right section to main layout
    mainLayout->addLayout(rightLayout);
}

void GeneralStore::populateBuyItemsList()
{
    // Example items. In a real application, these would come from a data model.
    buyItemsListWidget->addItem("Master's Hand (UGNE: 0001)");
    buyItemsListWidget->addItem("Bronze Dagger (250)");
    buyItemsListWidget->addItem("Dagger of Stealth (UGNE: 0010)");
    buyItemsListWidget->addItem("Iron Dagger (UGNE: 0999)");
    buyItemsListWidget->addItem("Lethe Dagger (UGNE: 0002)");
    buyItemsListWidget->addItem("Steel Dagger (UGNE: 0575)");
    buyItemsListWidget->addItem("Adamantile Dagger (UGNE: 0100)");
    buyItemsListWidget->addItem("Silver Cross (UGNE: 0573)");
    buyItemsListWidget->addItem("Bronze Sword (350)");
    // ... add more items as needed
}

// --- Slot Implementations (placeholders) ---
void GeneralStore::uncurseItem()
{
    qDebug() << "Uncurse item:" << uncurseItemLineEdit->text();
    // Logic for uncursing item
}

void GeneralStore::combineItems()
{
    qDebug() << "Combine item:" << combineItemLineEdit->text() << "with items:" << combineItemsLineEdit->text();
    // Logic for combining items
}

void GeneralStore::identifySellItem()
{
    QPushButton *senderButton = qobject_cast<QPushButton*>(sender());
    if (senderButton == sellButton) {
        qDebug() << "Sell item:" << identifySellItemLineEdit->text();
        // Logic for selling item
    } else if (senderButton == idButton) {
        qDebug() << "Identify item:" << identifySellItemLineEdit->text();
        // Logic for identifying item
    } else if (senderButton == infoButton) {
        qDebug() << "Show info for item:" << identifySellItemLineEdit->text();
        // Logic for showing item info
    }
}

void GeneralStore::buyItem()
{
    if (buyItemsListWidget->currentItem()) {
        qDebug() << "Buy item:" << buyItemsListWidget->currentItem()->text();
        // Logic for buying item
    } else {
        qDebug() << "No item selected to buy.";
    }
}

void GeneralStore::showItemInfo()
{
    QPushButton *senderButton = qobject_cast<QPushButton*>(sender());
    if (senderButton == infoButton) {
        qDebug() << "Show info for item in 'Identify, Realign & Sell':" << identifySellItemLineEdit->text();
    } else if (senderButton == buyInfoButton) {
        if (buyItemsListWidget->currentItem()) {
            qDebug() << "Show info for item in 'Buy Items':" << buyItemsListWidget->currentItem()->text();
        } else {
            qDebug() << "No item selected for info in 'Buy Items'.";
        }
    }
    // Logic to display detailed item information
}

void GeneralStore::searchItems(const QString &searchText)
{
    qDebug() << "Searching for:" << searchText;
    // Simple filtering logic
    for (int i = 0; i < buyItemsListWidget->count(); ++i) {
        QListWidgetItem *item = buyItemsListWidget->item(i);
        if (item->text().contains(searchText, Qt::CaseInsensitive)) {
            item->setHidden(false);
        } else {
            item->setHidden(true);
        }
    }
}

void GeneralStore::exitStore()
{
    qDebug() << "Exiting General Store.";
    close(); // Close the dialog
}
