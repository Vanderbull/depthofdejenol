name: Repo Maintenance

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    name: Purge Old Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean Old Drafts and Tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Set Threshold (7 days ago)
          THRESHOLD_DATE=$(date -d "7 days ago" +%Y-%m-%dT%H:%M:%SZ)
          THRESHOLD_SEC=$(date -d "$THRESHOLD_DATE" +%s)
          echo "Cleaning items created before: $THRESHOLD_DATE"

          # 2. Delete Release Drafts
          # Note: gh release list DOES support --json
          gh release list --limit 100 --json tagName,isDraft,createdAt | jq -c '.[] | select(.isDraft == true)' | while read -r release; do
            TAG=$(echo "$release" | jq -r '.tagName')
            CREATED_AT=$(echo "$release" | jq -r '.createdAt')
            
            if [[ "$CREATED_AT" < "$THRESHOLD_DATE" ]]; then
              echo "Purging release draft: $TAG"
              gh release delete "$TAG" --yes || true
            fi
          done

          # 3. Delete Old Orphaned Tags
          # gh api returns JSON by default, no --json flag needed
          gh api repos/${{ github.repository }}/git/matching-refs/tags --paginate | jq -c '.[]' | while read -r ref; do
            TAG_NAME=$(echo "$ref" | jq -r '.ref' | sed 's/refs\/tags\///')
            SHA=$(echo "$ref" | jq -r '.object.sha')
            
            # Fetch commit date using the correct gh api syntax
            # Use jq to extract the date from the raw JSON response
            COMMIT_DATE=$(gh api repos/${{ github.repository }}/commits/$SHA | jq -r '.commit.committer.date')
            COMMIT_SEC=$(date -d "$COMMIT_DATE" +%s)
            
            if [ "$COMMIT_SEC" -lt "$THRESHOLD_SEC" ]; then
              # Only delete if it doesn't belong to a non-draft release
              if ! gh release view "$TAG_NAME" > /dev/null 2>&1; then
                echo "Deleting old/orphaned tag: $TAG_NAME"
                gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" || echo "Skip: $TAG_NAME"
              fi
            fi
          done

      - name: Delete Old Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            try {
              const { data: { artifacts } } = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              for (const artifact of artifacts) {
                if (new Date(artifact.created_at).getTime() < sevenDaysAgo) {
                  console.log(`Deleting artifact: ${artifact.name}`);
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                }
              }
            } catch (e) { console.log("Artifact check completed."); }
