name: Repo Maintenance

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    name: Purge Old Drafts and Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Delete Drafts Older Than 7 Days
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Set the date 7 days ago
          THRESHOLD_DATE=$(date -d "7 days ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Scanning for drafts created before: $THRESHOLD_DATE"

          # 2. Get JSON data (more reliable than parsing text columns)
          # This specifically asks for drafts only.
          DRAFTS_JSON=$(gh release list --limit 100 --json tagName,isDraft,createdAt)

          # 3. Process the JSON using 'jq' (pre-installed on runners)
          echo "$DRAFTS_JSON" | jq -c '.[] | select(.isDraft == true)' | while read -r release; do
            TAG=$(echo "$release" | jq -r '.tagName')
            CREATED_AT=$(echo "$release" | jq -r '.createdAt')

            if [[ "$CREATED_AT" < "$THRESHOLD_DATE" ]]; then
              echo "!!! Found old draft: $TAG (Created: $CREATED_AT). Deleting..."
              gh release delete "$TAG" --yes --cleanup-tag
            else
              echo "--- Keeping draft: $TAG (Too new: $CREATED_AT)"
            fi
          done

      - name: Delete Artifacts Older Than 7 Days
        uses: actions/github-script@v7
        with:
          script: |
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const { data: { artifacts } } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            if (artifacts.length === 0) {
              console.log("No artifacts found.");
            }

            for (const artifact of artifacts) {
              const createdAt = new Date(artifact.created_at).getTime();
              if (createdAt < sevenDaysAgo) {
                console.log(`Deleting expired artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }
