name: Qt 6 Production Release

on:
  push:
    branches: [ "main", "develop" ]
    tags: ["v*"]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 5'

permissions:
  contents: write

jobs:
  build:
    name: Build Game (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Qt 6 & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential qmake6 qt6-base-dev qt6-multimedia-dev libgl1-mesa-dev

      - name: Configure and Compile
        run: |
          qmake6
          make -j$(nproc)

      # --- Upload the specific game_menu binary ---
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          # This assumes game_menu is created in the root directory
          path: game_menu
          if-no-files-found: error # Fails the build if the binary wasn't created

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-binary

      - name: Package Release Assets
        run: |
          # Grant execution permissions just in case
          chmod +x game_menu
          # Package into a compressed tarball
          tar -czvf game_menu_linux_x64.tar.gz game_menu

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: game_menu_linux_x64.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
