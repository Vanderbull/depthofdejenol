name: Project Status to Label Sync
on:
  project_item:
    types: [edited, converted]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: read
    steps:
      - name: Sync Status to Label
        uses: actions/github-script@v7
        with:
          script: |
            const { project_item } = context.payload;
            
            // 1. Get the new status value
            // We look through field_values to find the one named 'Status'
            const statusField = project_item.field_values.find(f => f.field_name === 'Status');
            const statusValue = statusField?.value;

            if (!statusValue) {
              console.log("No status change detected or field is not 'Status'.");
              return;
            }

            // 2. Identify the issue number 
            // project_item.content_type must be 'Issue'
            const issueNumber = project_item.content?.number;
            
            if (!issueNumber) {
              console.log("This project item is not a repository issue.");
              return;
            }

            // 3. Apply the label
            // GitHub automatically handles creating the label if it's new
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: [statusValue]
            });

            console.log(`Synced issue #${issueNumber} with label: ${statusValue}`);
